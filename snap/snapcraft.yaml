name: microk8s
adopt-info: microk8s
summary: Kubernetes for workstations and appliances
description: |-
  MicroK8s is a small, fast, secure, single node Kubernetes that installs on
  just about any Linux box. Use it for offline development, prototyping,
  testing, or use it on a VM as a small, cheap, reliable k8s for CI/CD. It's
  also a great k8s for appliances - develop your IoT apps for k8s and deploy
  them to MicroK8s on your boxes.

grade: stable
confinement: strict
base: core18

plugs:
  home-read-all:
    interface: home
    read: all
  ca-cert:
    interface: system-files
    read:
    - /etc/ssl/certs/ca-certificates.crt
  docker-privileged:
    interface: docker-support
    privileged-containers: true
  docker-unprivileged:
    interface: docker-support
    privileged-containers: false
  k8s-kubelet:
    interface: kubernetes-support
    flavor: kubelet
  k8s-kubeproxy:
    interface: kubernetes-support
    flavor: kubeproxy
  k8s-journald:
    interface: kubernetes-support
    flavor: autobind-unix
  dot-kube:
    interface: personal-files
    write:
    - $HOME/.kube
  ld-cache:
    interface: system-files
    read:
    - /etc/ld.so.cache

slots:
  microk8s:
    interface: content
    content: microk8s
    source:
      read: [$SNAP/.microk8s-info/microk8s]

hooks:
  configure:
    plugs:
    - dot-kube
  install:
    plugs:
    - network-bind
    - network-control
    - firewall-control
  remove:
    plugs:
    - k8s-kubelet
    - mount-observe
    - network-bind
    - network-control
    - firewall-control
  connect-plug-network-control:
    plugs:
      - dot-kube
      - network-control
  disconnect-plug-network-control:
    plugs:
      - dot-kube
      - network-control
  connect-plug-docker-privileged:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-docker-support:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-kubernetes-support:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-k8s-kubelet:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-k8s-kubeproxy:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-dot-kube:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-network:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-network-bind:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-network-observe:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-firewall-control:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-process-control:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-kernel-module-observe:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-mount-observe:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-hardware-observe:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-system-observe:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-ca-cert:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-home:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-opengl:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-k8s-journald:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-ld-cache:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-cifs-mount:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-fuse-support:
    plugs:
      - dot-kube
      - network-bind
  connect-plug-kernel-crypto-api:
    plugs:
      - dot-kube
      - network-bind

apps:
  microk8s:
    command: microk8s.wrapper
    plugs:
    - docker-unprivileged
    - network-control
  daemon-etcd:
    command: run-etcd-with-args
    daemon: simple
    plugs:
    - network-bind
  daemon-flanneld:
    command: run-flanneld-with-args
    daemon: simple
    plugs:
    - network-bind
    - network-control
    - firewall-control
  daemon-containerd:
    command: run-containerd-with-args
    daemon: simple
    plugs:
    - ld-cache
    - k8s-journald
    - network-bind
    - docker-support
    - docker-privileged
    - firewall-control
    - network-control
    - mount-observe
    - kubernetes-support
    - opengl
    - cifs-mount
    - fuse-support
    - kernel-crypto-api
  daemon-kubelite:
    command: run-kubelite-with-args
    daemon: simple
    plugs:
    - dot-kube
    - docker-support
    - docker-privileged
    - firewall-control
    - hardware-observe
    - kubernetes-support
    - mount-observe
    - network-bind
    - network-observe
    - network-control
    - process-control
    - system-observe
    - opengl
    - kernel-module-observe
  daemon-apiserver:
    command: run-null-daemon
    daemon: simple
    plugs:
    - network-bind
    - network-observe
    - network-control
    - k8s-journald
    - kubernetes-support
  daemon-apiserver-kicker:
    command: apiservice-kicker
    daemon: simple
    plugs:
    - kernel-module-control
    - network-bind
    - network-observe
    - network-control
    - k8s-journald
    - kubernetes-support
  daemon-control-plane-kicker:
    command: run-null-daemon
    daemon: simple
    plugs:
    - network-bind
    - network-observe
    - network-control
    - k8s-journald
    - kubernetes-support
  daemon-cluster-agent:
    command: run-cluster-agent-with-args
    daemon: simple
    plugs:
    - mount-observe
    - network-bind
    - network-observe
    - network-control
  daemon-controller-manager:
    command: run-null-daemon
    daemon: simple
    plugs:
    - network-bind
    - docker-support
    - docker-privileged
    - firewall-control
    - k8s-journald
    - network-control
  daemon-scheduler:
    command: run-null-daemon
    daemon: simple
    plugs:
    - network-bind
    - k8s-journald
  daemon-kubelet:
    command: run-null-daemon
    daemon: simple
    plugs:
    - dot-kube
    - firewall-control
    - hardware-observe
    - k8s-kubelet
    - k8s-journald
    - mount-observe
    - network-bind
    - network-control
    - process-control
    - system-observe
    - opengl
  daemon-proxy:
    command: run-null-daemon
    daemon: simple
    plugs:
    - network-bind
    - network-control
    - network-observe
    - firewall-control
    - k8s-kubeproxy
    - kernel-module-observe
    - mount-observe
    - system-observe
  dashboard-proxy:
    command: microk8s-dashboard-proxy.wrapper
    plugs:
    - network-bind
    - network-control
    - network-observe
    - firewall-control
    - k8s-kubeproxy
    - kernel-module-observe
    - mount-observe
    - system-observe
  kubectl:
    command: microk8s-kubectl.wrapper
    completer: kubectl.bash
    plugs:
    - docker-unprivileged
    - dot-kube
    - home-read-all
    - firewall-control
    - network-bind
    - k8s-kubelet
    - hardware-observe
    - mount-observe
    - network-control
    - process-control
    - system-observe
  add-node:
    command: microk8s-add-node.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  refresh-certs:
    command: microk8s-refresh-certs.wrapper
  join:
    command: microk8s-join.wrapper
    plugs:
    - network
    - mount-observe
  remove-node:
    command: microk8s-remove-node.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  leave:
    command: microk8s-leave.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  ctr:
    command: microk8s-ctr.wrapper
    plugs:
    - dot-kube
    - home-read-all
    - firewall-control
    - network-bind
    - k8s-kubelet
    - hardware-observe
    - mount-observe
    - network-control
    - process-control
    - system-observe
  inspect:
    command: inspect.sh
    plugs:
    - system-observe
    - firewall-control
  enable:
    command: microk8s-enable.wrapper
    plugs:
    - home-read-all
    - network
    - network-control
    - ca-cert
    - kernel-module-observe
    - opengl
  disable:
    command: microk8s-disable.wrapper
    plugs:
    - home
    - network
    - network-control
    - ca-cert
    - kernel-module-observe
    - opengl
  start:
    command: microk8s-start.wrapper
    plugs:
    - network
  stop:
    command: microk8s-stop.wrapper
    plugs:
    - network
  status:
    command: microk8s-status.wrapper
    plugs:
    - network
  config:
    command: microk8s-config.wrapper
  reset:
    command: microk8s-reset.wrapper
    plugs:
    - network
  istioctl:
    command: microk8s-istioctl.wrapper
    plugs:
    - network
  linkerd:
    command: microk8s-linkerd.wrapper
    plugs:
    - network
  helm:
    command: microk8s-helm.wrapper
    plugs:
    - network
  helm3:
    command: microk8s-helm3.wrapper
    plugs:
    - network
  cilium:
    command: microk8s-cilium.wrapper
    plugs:
    - network
  juju:
    command: microk8s-juju.wrapper
    plugs:
    - network
  dbctl:
    command: microk8s-dbctl.wrapper

passthrough:
  system-usernames:
    snap_daemon: shared
  layout:
    /usr/libexec:
      bind: $SNAP_COMMON/usr/libexec
    /usr/local/lib:
      bind: $SNAP_COMMON/usr/local/lib
    /var/lib/cni:
      bind: $SNAP_COMMON/var/lib/cni
    /var/log/pods:
      bind: $SNAP_COMMON/var/log/pods
    /var/log/containers:
      bind: $SNAP_COMMON/var/log/containers
    /var/lib/kubelet:
      bind: $SNAP_DATA/kubelet
    /var/lib/kube-proxy:
      bind: $SNAP_DATA/kube-proxy
    /etc/service/enabled/felix/supervise/lock:
      bind-file: $SNAP_COMMON/etc/service/enabled/felix/supervise/lock

parts:
  raft:
    source: https://github.com/canonical/raft
    build-attributes: [no-patchelf]
    source-type: git
    plugin: autotools
    build-packages:
      - liblz4-dev
    stage-packages:
      - libuv1
    organize:
      usr/lib/: lib/
      include/: usr/include/
    prime:
      - lib/libraft*so*
      - usr/include/

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.33.0
    build-attributes: [no-patchelf]
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex
      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i
      set +ex
      snapcraftctl build
    organize:
      include/: usr/include/
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*
      - usr/include/

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    build-attributes: [no-patchelf]
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
      - pkg-config
    organize:
      usr/lib/: lib/
      include/: usr/include/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*
      - usr/include/

  dqlite-client:
    build-snaps: [go]
    after: [sqlite, dqlite]
    source: https://github.com/canonical/go-dqlite
    source-type: git
    plugin: go
    go-channel: 1.15/stable
    build-packages:
      - libsqlite3-dev
    go-importpath: github.com/canonical/go-dqlite
    override-build: |
      set -eux
      snap refresh go --channel=1.15/stable || true
      go version
      export GOPATH=${SNAPCRAFT_STAGE}
      CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/usr/include/" CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib" go get -tags libsqlite3 github.com/canonical/go-dqlite/cmd/dqlite
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp $GOPATH/bin/dqlite $SNAPCRAFT_PART_INSTALL/bin/

  etcd:
    plugin: dump
    source: build-scripts/
    build-snaps: [go]
    override-build: |
      . ./set-env-variables.sh
      case ${SNAPCRAFT_ARCH_TRIPLET%%-*} in
      x86_64|aarch64)
        echo "Supported arch by etcd - use official binary"
        curl -LO https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-$KUBE_ARCH.tar.gz
        tar -xzvf etcd-*.tar.gz --strip-components=1
        ;;
      *)
        echo "Unsupported arch by etcd - build from sources"
        curl -LO https://github.com/etcd-io/etcd/archive/${ETCD_VERSION}.tar.gz
        tar -xzf *.tar.gz
        cd etcd-*
        go mod vendor
        ./build
        cp -av bin/* ../
        echo "End of build"
      esac
      snapcraftctl build
    stage:
      - etcd
      - etcdctl

  cni:
    plugin: dump
    source: build-scripts/
    override-build: |
      . ./set-env-variables.sh
      rm -rf cni*
      curl -LO https://github.com/containernetworking/plugins/releases/download/${CNI_VERSION}/cni-plugins-linux-$KUBE_ARCH-${CNI_VERSION}.tgz
      mkdir cni
      tar -xzvf cni-*.tgz -C cni/
      snapcraftctl build
    organize:
      ./cni/*: opt/cni/bin/
    filesets:
      bins: [./opt/cni/bin/*]
    stage: [$bins]

  flanneld:
    plugin: dump
    source: build-scripts/
    override-build: |
      . ./set-env-variables.sh
      curl -LO https://github.com/coreos/flannel/releases/download/${FLANNELD_VERSION}/flannel-${FLANNELD_VERSION}-linux-${KUBE_ARCH}.tar.gz
      tar -xzvf flannel-*.tar.gz
      snapcraftctl build
    organize:
      flanneld: opt/cni/bin/
    stage:
      - opt/cni/bin/flanneld

  k8s-binaries:
    after: [dqlite]
    build-snaps: [go]
    plugin: dump
    build-attributes: [no-patchelf]
    source: build-scripts/
    build-packages:
      - build-essential
      - curl
      - git
    override-build: |
      set -eux
      snap refresh go --channel=1.16/stable || true
      . ./set-env-variables.sh

      # if "${KUBE_SNAP_BINS}" exist we have to use the binaries from there
      # if "${KUBE_SNAP_BINS}" does not exist but it is set we will put the k8s binaries there
      # if "${KUBE_SNAP_BINS}" does not exist and it is not set we do not need to keep the created binaries
      if [ ! -e "${KUBE_SNAP_BINS}" ]; then
        if [ -z "${KUBE_SNAP_BINS}" ]; then
          . ./set-env-binaries-location.sh
        fi
        echo "Building k8s binaries"
        . ./build-k8s-binaries.sh
      else
        echo "Binaries provided in $KUBE_SNAP_BINS"
      fi
      mkdir -p bins/
      cp build/kube_bins/$KUBERNETES_TAG/$KUBE_ARCH/* bins/

      # Add bash completion for microk8s kubectl.
      bins/kubectl completion bash | sed "s/complete -o default -F __start_kubectl kubectl/complete -o default -F __start_kubectl microk8s kubectl/g" | sed "s/complete -o default -o nospace -F __start_kubectl kubectl/complete -o default -o nospace -F __start_kubectl kubectl/g" > kubectl.bash
      bins/kubectl completion bash | sed "s/complete -o default -F __start_kubectl kubectl/complete -o default -F __start_kubectl microk8s.kubectl/g" | sed "s/complete -o default -o nospace -F __start_kubectl kubectl/complete -o default -o nospace -F __start_kubectl kubectl/g" > kubectl.bash

      snapcraftctl build
    organize:
      bins/*: .
    stage:
      - kubelite
      - kubectl
      - kubectl.bash

  libmnl:
    plugin: autotools
    source: https://www.netfilter.org/pub/libmnl/libmnl-1.0.4.tar.bz2

  libnftnl:
    after:
      - libmnl
    plugin: autotools
    source: https://www.netfilter.org/projects/libnftnl/files/libnftnl-1.1.8.tar.bz2
    build-packages:
      - libjansson-dev

  iptables:
    after:
      - libnftnl
    source: https://www.netfilter.org/projects/iptables/files/iptables-1.8.6.tar.bz2
    plugin: autotools
    build-packages:
      - bison
      - flex
      - libnfnetlink-dev
      - libnetfilter-conntrack3
      - libnetfilter-conntrack-dev
    configflags:
      - "--disable-shared"
      - "--enable-static"
    prime: [-bin/iptables-xml]

  migrator:
    build-snaps: [go]
    source: https://github.com/ktsakalozos/go-migrator
    source-type: git
    plugin: go
    go-channel: 1.15/stable
    go-importpath: github.com/ktsakalozos/go-migrator
    build-packages:
      - gcc
    prime:
      - bin/migrator

  containerd:
    build-snaps: [go]
    after: [iptables, runc]
    build-attributes: [no-patchelf]
    source: build-scripts/
    plugin: dump
    build-packages:
      - btrfs-tools
      - libseccomp-dev
    override-build: |
      set -eux
      . $SNAPCRAFT_PART_SRC/set-env-variables.sh
      snap refresh go --channel=1.15/stable || true
      go version
      export GOPATH=$(realpath ../go)
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin

      # Build containerd
      rm -rf $GOPATH
      mkdir -p $GOPATH
      go get -d github.com/containerd/containerd
      (
        cd $GOPATH/src/github.com/containerd/containerd
        git checkout -f ${CONTAINERD_COMMIT}
        # building the btrfs driver can be disabled via the
        # build tag no_btrfs, removing this dependency
        make
      )
      cp $GOPATH/src/github.com/containerd/containerd/bin/* $SNAPCRAFT_PART_INSTALL/bin/
      rm $SNAPCRAFT_PART_INSTALL/bin/containerd-stress

      # Assemble the snap
      snapcraftctl build
    organize:
      containerd/install/bin/*: bin/
    stage-packages:
      - libnss-myhostname
      - libnss-resolve
      - libnss-mymachines
      - conntrack
      - libssl1.0.0
    stage:
      - -sbin/xtables-multi
      - -sbin/iptables*
      - -lib/xtables

  runc:
    build-snaps: [go]
    after: [iptables]
    source: build-scripts/
    plugin: dump
    build-packages:
      - btrfs-tools
      - libseccomp-dev
    override-build: |
      set -eux
      . $SNAPCRAFT_PART_SRC/set-env-variables.sh
      snap refresh go --channel=1.15/stable || true
      go version
      export GOPATH=$(realpath ../go)
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin

      # Build runc
      go get -d github.com/opencontainers/runc
      (
        cd $GOPATH/src/github.com/opencontainers/runc
        git checkout ${RUNC_COMMIT}
        git config user.email "microk8s-builder-bot@ubuntu.com"
        git config user.name "MicroK8s builder bot"
        git am $SNAPCRAFT_PART_SRC/patches/runc/*
        make BUILDTAGS='seccomp apparmor'
      )
      cp $GOPATH/src/github.com/opencontainers/runc/runc $SNAPCRAFT_PART_INSTALL/bin/

      # Assemble the snap
      snapcraftctl build
    stage:
      - -sbin/xtables-multi
      - -sbin/iptables*
      - -lib/xtables

  bash-utils:
    source: snap
    plugin: dump
    stage-packages:
      - curl
      - aufs-tools
      - gawk
      - sed
      - socat
      - grep
      - jq
      - hostname
      - squashfs-tools
      - tar
      - coreutils
      - diffutils
      - iproute2
      - ethtool
      - net-tools
      - util-linux
      - libatm1
      - zfsutils-linux

  cluster-agent:
    plugin: python
    python-version: python3
    source: .
    python-packages:
      - flask == 1.1.2
      - PyYAML == 5.3.1
      - netifaces == 0.10.9
    stage-packages:
      - python3-openssl
      - openssl
      - python3-requests
      - gunicorn3
      - python3-click
      - python3-dateutil

  microk8s:
    after: [containerd, dqlite, k8s-binaries]
    plugin: dump
    build-attributes: [no-patchelf]
    build-packages:
      - make
      - mercurial
      - git
      - rsync
      - openssl
      - file
      - dpkg
    source: .
    prime:
      - -README*
      - -installer*
      - -tests*
      - -docs*
      - -build*
      - -go*
      - -snap*
    override-build: |
      set -eux

      . build-scripts/set-env-variables.sh

      snapcraftctl set-version "${KUBE_VERSION}"

      echo "Setting default daemon configs"
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/default-args .

      echo "Building certs"
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/certs .
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/certs-beta .

      echo "Preparing containerd"
      cp $KUBE_SNAP_ROOT/microk8s-resources/containerd-profile .

      echo "Preparing user config"
      cp $KUBE_SNAP_ROOT/microk8s-resources/client.config.template .

      echo "Creating commands and wrappers"
      cp $KUBE_SNAP_ROOT/microk8s-resources/wrappers/* .

      cp -r $KUBE_SNAP_ROOT/microk8s-resources/actions .
      if [ "${ARCH}" != "amd64" ]
      then
        # Some actions are only available on amd64
        # Nvidia support
        rm "actions/enable.gpu.sh"
        rm "actions/disable.gpu.sh"
        rm "actions/gpu.yaml"
        # Istio support
        rm "actions/enable.istio.sh"
        rm "actions/disable.istio.sh"
        # Knative support
        rm "actions/enable.knative.sh"
        rm "actions/disable.knative.sh"
        # Fluentd support
        rm "actions/enable.fluentd.sh"
        rm "actions/disable.fluentd.sh"
        rm -rf "actions/fluentd"
        # Jeager support
        rm "actions/enable.jaeger.sh"
        rm "actions/disable.jaeger.sh"
        rm -rf "actions/jaeger"
        # Juju support
        rm "actions/enable.juju.sh"
        rm "actions/disable.juju.sh"
        # Kubeflow support
        rm "actions/enable.kubeflow.sh"
        rm "actions/disable.kubeflow.sh"
        # Kubeflow support
        rm "actions/enable.multus.sh"
        rm "actions/disable.multus.sh"
        rm "actions/multus.yaml"
        # KEDA support
        rm "actions/enable.keda.sh"
        rm "actions/disable.keda.sh"
        # OpenEBS support
        rm "actions/enable.openebs.sh"
        rm "actions/disable.openebs.sh"
        # OpenFaaS support
        rm "actions/enable.openfaas.sh"
        rm "actions/disable.openfaas.sh"
      fi

      echo "Creating inspect hook"
      cp $KUBE_SNAP_ROOT/scripts/inspect.sh .

      snapcraftctl build

  juju:
    plugin: dump
    source: https://launchpad.net/juju/2.8/2.8.10/+download/juju-2.8.10-k8s.tar.xz
    source-type: tar
    organize:
      juju: bin/juju
    prime:
      - bin/juju

slots:
  microk8s:
    interface: content
    content: microk8s
    source:
      read: [$SNAP/.microk8s-info/microk8s]
