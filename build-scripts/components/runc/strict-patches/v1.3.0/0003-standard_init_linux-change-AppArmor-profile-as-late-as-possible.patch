From a7a99eb68f7d7dc1d08a1f1790e5be6dc19fd4ec Mon Sep 17 00:00:00 2001
From: Homayoon Alimohammadi <homayoonalimohammadi@gmail.com>
Date: Thu, 18 Dec 2025 15:09:46 +0400
Subject: [PATCH] fix(standard_init_linux): standard_init_linux: change
 AppArmor profile as late as possible

Signed-off-by: Homayoon Alimohammadi <homayoonalimohammadi@gmail.com>
---
 libcontainer/standard_init_linux.go | 17 +++++++++--------
 1 file changed, 9 insertions(+), 8 deletions(-)

diff --git a/libcontainer/standard_init_linux.go b/libcontainer/standard_init_linux.go
index 21516bd3..8e6fb51d 100644
--- a/libcontainer/standard_init_linux.go
+++ b/libcontainer/standard_init_linux.go
@@ -128,9 +128,6 @@ func (l *linuxStandardInit) Init() error {
 			return &os.SyscallError{Syscall: "setdomainname", Err: err}
 		}
 	}
-	if err := apparmor.ApplyProfile(l.config.AppArmorProfile); err != nil {
-		return fmt.Errorf("unable to apply apparmor profile: %w", err)
-	}
 
 	if err := sys.WriteSysctls(l.config.Config.Sysctl); err != nil {
 		return err
@@ -148,11 +145,6 @@ func (l *linuxStandardInit) Init() error {
 	if err != nil {
 		return fmt.Errorf("can't get pdeath signal: %w", err)
 	}
-	if l.config.NoNewPrivileges {
-		if err := unix.Prctl(unix.PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0); err != nil {
-			return &os.SyscallError{Syscall: "prctl(SET_NO_NEW_PRIVS)", Err: err}
-		}
-	}
 
 	if err := setupScheduler(l.config); err != nil {
 		return err
@@ -168,6 +160,15 @@ func (l *linuxStandardInit) Init() error {
 	if err := syncParentReady(l.pipe); err != nil {
 		return fmt.Errorf("sync ready: %w", err)
 	}
+	if err := apparmor.ApplyProfile(l.config.AppArmorProfile); err != nil {
+		return fmt.Errorf("apply apparmor profile: %w", err)
+	}
+	if l.config.NoNewPrivileges {
+		if err := unix.Prctl(unix.PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0); err != nil {
+			return fmt.Errorf("set nonewprivileges: %w", err)
+		}
+	}
+
 	if err := selinux.SetExecLabel(l.config.ProcessLabel); err != nil {
 		return fmt.Errorf("can't set process label: %w", err)
 	}
-- 
2.48.1
